## 标准化文稿录入
### 前置工作
1. 检查当前的数据库是否已经有该份文件。检查的办法：**在 Github 本库首页 Ctrl+F 检索**文件名或文件名中部分关键词；**在数据库中的“来源”过滤检索**文件名或文件名中部分关键词；最后**在 Issues 中查看**当前是否有关于该文件的录入或录入计划正在进行。如果在以上三个步骤中的某一步骤检索到了文件，则查看待录入的文件是否和已有的为同一版本，如果不是同一版本，可以继续录入。
2. 在 Issues 中创建 issue，选择“自动化 OCR 文稿录入”，根据模板中的提示录入。如果不会使用，请新建空白 issue 请求帮助，并附带文稿文件（图片/pdf/epub/压缩包等格式）或者链接，尽量提交可以溯源到的源头高清扫描版文件，对于国内出版物，通常指超星、读秀等处流出的文件，对于国外出版物，溯源文件会相对困难，在没有找到高清扫描版文件的情况下，可以提交模糊的扫描版文件或者二次加工排版之后的文件，对于非出版物，即各种民间流传文件，可以直接提交获得的原文件。

### 文稿的解析
完整的 OCR 模板示例如下：
```
{
  source_name: '毛泽东全集第一卷', // 来源文件，书籍，数据库，报纸等等
  archive_id: 1, // 子仓库id，banned-historical-archives[id]，默认为 1
  internal: false,
  official: false,
  author: '',
  articles: [{
    title: '在中央政治局会议上的讲话',
    authors: ['毛泽东', '江青'], // 作者
    dates: [
      {
        year: 1949,
        month: 10,
        day: 1,
      },
      {
        year: 1976,
        month: 10,
        day: 1,
      },
    ], // 时间 或者 时间范围 或者 多个时间点
    is_range_date: false, // 默认为false，如果为 true 表示一段时间（从49年到76年），如果为false表示多/单个时间点
    alias: '', // 标题别名
    page_start: 1, // 从图片集第一张到第五张，如果是图片集不填表示从第一张到最后一张，如果是pdf，必须填写page_start和page_end
    page_end: 5,
    ocr: {
      min_box_size: 20
    }, // 此参数将继承全局ocr参数并覆盖（此参数优先级更高），默认为空
    ocr_exceptions: {
      "3": {
        content_thresholds: [0.2, 0.2, 0.1, 0.1],
        // ...其他ocr参数（可选）
      },
    } // 默认为空
  }],
  ocr: { // ocr 参数 以及 默认参数
    rec_model: 'ch_ppocr_mobile_v2.0',
    rec_backend: 'onnx',
    det_model: 'ch_PP-OCRv3_det',
    det_backend: 'onnx',
    resized_shape: 1496, // 在OCR前resize到这个尺寸，这个参数仅影响识别效果，识别结果的坐标仍是取决于原图像尺寸
    box_score_thresh: 0.3,
    min_box_size: 10,
    auto_vsplit: true, // 用于分页或者处理特殊的排版。如果为 ture，当页面宽度大于高度时，将ocr结果中页面中间(vsplit的位置)分开
    vsplit: 0.5, // 如果设置为0.5，ocr结果将从页面宽度的50%处分割，如果为0表示不分割。当auto_vsplit为false且vsplit不为0时，表示任何页面都进行分割。
    content_thresholds: [0.0, 0.0, 0.0, 0.0], // 通常需要忽略在页面边缘的页眉，页码或者噪声，数组内4个数值分别表示上下左右相对于宽高的比例， 例如 [0.1,0,0,0] 表示忽略顶部占总高度百分之10的内容
    line_merge_threshold: 30, // 单位像素，如果小于这个阈值将被视为同一行
    standard_paragraph_merge_strategy_threshold: 0, // 标准段落合并策略，0表示禁用（请在标准和差分策略中二选一），如果是0.2，当一行中最左侧的x坐标超过页面宽度的20%表示新段落，否则向上一行合并
    differential_paragraph_merge_strategy_threshold: 30, // 差分段落合并策略，0表示禁用，如果为30，这一行的最左侧的x坐标减去上一行的最左侧的x坐标大于30像素 而且 这一行的最左侧的x坐标减去下一行的最左侧的x坐标大于30像素 时表示这一行是新的段落，否则向上一行合并
  },
  ocr_exceptions: {
    "3": {
      content_thresholds: [0.2, 0.2, 0.1, 0.1],
      // ...其他ocr参数（可选）
    },
  } // 例外， 比如第三页的ocr参数与其他页面不同，默认为空
    // 此参数将继承全局ocr参数和article中的ocr参数，并覆盖（此参数优先级更高），默认为空
}
```
从实践来解释一些重要的属性：
- source_name：对于这个属性，保证填写好三个信息——文稿名、出处和日期——为了保证这个属性相对唯一，**尽量不要直接填写文稿的名字**，“毛泽东选集第一卷（人民出版社1992年）”或“毛泽东选集（1992年）”比仅仅填写“毛泽东选集第一卷”要好得多，对于书籍，**一般需要在括号内附带相应的出版社或出版公司**（是否填写全称可以随意，根本目的是为了让使用者看到 source_name 就可以获知指的是哪本书），对于以上例子，众所周知现行的《毛泽东选集》只有人民出版社的两个版本，因此出版社可以省略，但是对于其他的书籍，录入者往往无法得知是否存在其他版本，所以最好加上出版方。对于图片集的录入，可以使用“张春桥同志在市革会扩大会议上的讲话（1969.xx.xx）”这样的格式，其中**括号前的内容通常取图片集中的原文标题，如果没有标题，则根据原文自拟**。**日期的填写非常重要**，尤其是对于图片集，对于书籍来说，则可以让使用者迅速知道录入物所处的时间段（1976年前或者后）。
- archive_id：图片集放在 1，杂志、期刊放在 2，毛时代及以后的文件放在 3，马恩时代放在 4，列斯时代的放在 5。文件属于哪个时代由录入者主观决定。
- internal：是否属于内部文件。由录入者根据内容决定。
- official：是否属于官方文件。由录入者根据内容决定。
- author：填写作者、出版社与日期，无格式，录入者自由书写。
- title：最好能根据文字的内容，确定出一个标题，比如“张春桥同志在市革会扩大会议上的讲话”，而不是直接使用原文的标题，当然如果原文标题十分符合内容，可以直接使用。
- alias: 这里放原文标题，如果 title 和 alias 一样，这项可以删除不写。
- authors：这里的作者范围并不很狭义。比如一篇文章内，有多个主要发言人，那么这几个发言人都是作者。但是也不要随意扩充，把握一个度就好。
- **ocr 相关**：content_thresholds 用于排除上右下左杂物，一般每次录入都必须携带；standard_paragraph_merge_strategy_threshold 和 differential_paragraph_merge_strategy_threshold，如果录入物为二次加工排版之后的文件，一般必须设置这两项——将前者计算设置，同时将后者设零，如果录入物为书籍，则一半不需要填写此项；auto_vsplit 和 vsplit：一般在文件文字有分栏现象时使用，auto_vsplit 设置为 false 的同时填写计算好的 vsplit。（注：ocr 的参数使用有两个范围——全局和文章，可根据需要设置）

以下是一份日常实践中的 OCR Issue：
```
{
    source_name: '陈伯达最后口述回忆（阳光环球2005年）',
    internal: false,
    official: false,
    author: '陈晓农著，阳光环球2005年',
    archive_id: 3,
    articles: [{
        title: '附图',
        authors: ['陈晓农'],
        page_start: 9,
        page_end: 14,
        dates: [
            {
                year: 2005,
            }
        ],
    }, ... // 后面的对象因展示需要省略],
    ocr: {
        content_thresholds: [0.068, 0, 0, 0],
    },
}
```

## 标准化的文稿校对
校对的原则：**完全忠于原文。原文有什么就录入与校对什么。不要删除或增加内容**。

1. 进入文稿，页面右上角显示了文稿校对记录的数量（可点击查看详情），如果为 0 表示未经过校对，注意不同来源的校对记录是分开的。
![image](https://user-images.githubusercontent.com/109972625/183044854-43b85c29-ec5a-4a28-be9f-f77ab7ccfb5c.png)
2. 在将要校对的文稿页面选择“对比”->“对比原始文件并校对”。
![图片](https://user-images.githubusercontent.com/109972625/193404100-c4b7f8d2-2d03-4508-8636-7484d19fc660.png)
3. 校对正文。注意分清楚段落的类型。title、subtitle、subtitle1……分别代表一级、二级、三级……标题，根据原文设置；appellation：开头“同志们：”等处使用；subdate：开头日期“（一九七五年一月一日）”、地点“人民大会堂西厅”等使用；quotation：原文中引用他人的话时使用；signature：原文最后署名时使用，文末的日期也属于这个类型（联想日常生活中最后居右的文字）；image 和 image_description：插图和插图的描述使用；描述：比如“未经首长审阅”、“某某组织印发”这类内容即使在原文中放置在开头，也要填写在“描述”中；注释：正文中注释使用〔1〕〔2〕等序号实现注释功能，注意，原文中脚注、尾注等所有各类注释需要统一归在一类，即按顺序给各类注释混合编号。
4. 编辑完成后提交变更，如果无误也可以提交，使其他人知道此文稿已经被校对。
5. 然后会跳转到 issue 发帖页面并自动填充好内容（不要修改），点击发布后机器人会生成相应代码发起 pull request，然后等待审核。

## 校对规范
* 使用全角符号
* 叉号应当统一用“×”，而不是英文的“X”；人名中间的圆点用“·”
* 正文、描述与注释出现的各种日期，尊重原文录入。
* 正文中一般情况下不使用空格（英文单词与中文之间的空格由系统添加）
* 段落内不要使用回车换行，请用"在上方插入"或者"在下方插入"代替
* 添加正文中的注释或者修改注释时使用“〔”，“〕”符号

## 注意事项
**请在校对前检查以下问题**
* 标题错误（指浏览器顶部显示的标题（source_name），不是正文中的标题（title））；
* 日期或作者错误/缺漏；
* 大段文字缺失、原始文件页数错误；

以上问题如果出现，需要发 issue 解决。